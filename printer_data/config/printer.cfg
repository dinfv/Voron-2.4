#####################################################################
# 				VORON 2.4 - PRINTER.CFG ORGANIZADO E COMENTADO
#####################################################################


# ===================================================================
# 						1. INCLUSÕES E VARIÁVEIS
# ===================================================================

# Inclui arquivos de configuração externos para organização e módulos.
[include mainsail.cfg]
[include H36_combo.cfg]             # Configuração do Hotend (H36 ou similar)
[include flap_temp_control.cfg]     # Controle de temperatura para a aba (flap)
[include flap_main.cfg]
[include homing.cfg]                # Rotinas de Homing customizadas
[include moonraker_obico_macros.cfg]

[save_variables]
filename:~/variables.cfg            # Arquivo para armazenar variáveis salvas (ex: Z_OFFSET).

[force_move] 
enable_force_move: true             # Habilita o comando FORCE_MOVE.

# ===================================================================
# 						2. CONFIGURAÇÃO DE MCUS
# ===================================================================

# MCU Principal (MKS Monster 8 ou placa principal)
[mcu]
## Obtenha o serial por "ls -l /dev/serial/by-id/"
serial: /dev/serial/by-id/usb-Klipper_stm32f407xx_400048001151333233363732-if00 
restart_method: command

# MCU do Cartographer
[mcu cartographer]
serial: /dev/serial/by-id/usb-Cartographer_614e_1C0021001643304B4E363120-if00
restart_method: command

# ===================================================================
# 					3. CINEMÁTICA E LIMITES DA IMPRESSORA
# ===================================================================

[printer]
kinematics: corexy
max_velocity: 600                   # Velocidade máxima (mm/s). 
max_accel: 10000   			        # Aceleração máxima (mm/s²).
max_z_velocity: 25 			        # Velocidade máxima do eixo Z (mm/s).
max_z_accel: 30                     # Aceleração máxima do eixo Z (mm/s²).
square_corner_velocity: 5.0         # Velocidade em cantos (mm/s).

# ===================================================================
# 					4. STEPPERS (MOTORES DE PASSO)
# ===================================================================

### Eixo X (TMC5160)
[stepper_x]
step_pin: !PC14
dir_pin: !PC13
enable_pin:!PC15
microsteps: 64                      
rotation_distance: 40
full_steps_per_rotation:200         # 200 para 1.8° / 400 para 0.9°.
endstop_pin: tmc5160_stepper_x:virtual_endstop # Homing sem contato (StallGuard).
position_min: 0  
position_endstop: 298               # Posição de parada do StallGuard (ajuste fino).
position_max: 300
homing_speed: 85
homing_retract_dist:0

### Eixo Y (TMC5160)
[stepper_y]
step_pin:!PE5
dir_pin:!PE4
enable_pin:!PC15                    
microsteps:64                       
rotation_distance: 40
full_steps_per_rotation:200 
endstop_pin: tmc5160_stepper_y:virtual_endstop
position_min: 0
position_endstop:311
position_max:311
homing_speed: 85
homing_retract_dist:0

### Eixo Z0 (TMC2209)
[stepper_z]
step_pin:PC7
dir_pin:!PC6
enable_pin:!PC8
microsteps:16
rotation_distance:40
full_steps_per_rotation: 200
gear_ratio:80:16                    # Relação de engrenagens 80:16.
endstop_pin:probe:z_virtual_endstop # Usa a sonda Cartographer como endstop de Z.
position_max: 300
position_min: -15
homing_speed: 8
second_homing_speed: 3
# position_endstop: -5             # O valor final será salvo no bloco SAVE_CONFIG.

### Eixo Z1 (TMC2209)
[stepper_z1]
step_pin:PD2
dir_pin:PD1
enable_pin:!PD3
microsteps: 16
rotation_distance: 40
full_steps_per_rotation: 200
gear_ratio: 80:16

### Eixo Z2 (TMC2209)
[stepper_z2]
step_pin:PD6
dir_pin:!PD5
enable_pin:!PD7
microsteps:16
rotation_distance: 40
full_steps_per_rotation: 200
gear_ratio: 80:16

### Eixo Z3 (TMC2209)
[stepper_z3]
step_pin:PE1
dir_pin:PE0
enable_pin: !PE2
microsteps: 16
rotation_distance: 40
full_steps_per_rotation: 200
gear_ratio: 80:16

# ===================================================================
# 					5. CONFIGURAÇÃO DE DRIVERS (TMC)
# ===================================================================

### TMC5160 - Eixo X
[tmc5160 stepper_x]
cs_pin: PE6
diag1_pin: ^!PA14                    # Pino DIAG para StallGuard.
run_current: 2.0                     # Corrente alta. Monitore a temperatura.
hold_current: 1.2
sense_resistor: 0.022
stealthchop_threshold: 0      # Força o SpreadCycle (mais torque, menos silencioso).
spi_software_sclk_pin: PE12
spi_software_mosi_pin: PE14
spi_software_miso_pin: PE13
interpolate: true

### TMC5160 - Eixo Y
[tmc5160 stepper_y]
cs_pin: PE3
diag1_pin: ^!PA15
run_current: 2.0
hold_current: 1.2
sense_resistor: 0.022
stealthchop_threshold: 0
spi_software_sclk_pin: PE12
spi_software_mosi_pin: PE14
spi_software_miso_pin: PE13
interpolate: true

### TMC2209 - Eixos Z
[tmc2209 stepper_z]
uart_pin: PB7
interpolate: true
run_current: 0.8                     # Corrente padrão para motores Z.
hold_current: 0.5
stealthchop_threshold: 99999         # Mantém o StealthChop ligado em todas as velocidades.

[tmc2209 stepper_z1]
uart_pin: PD4
interpolate: true
run_current: 0.8
hold_current: 0.5
stealthchop_threshold: 99999

[tmc2209 stepper_z2]
uart_pin: PD0
run_current: 0.8
hold_current: 0.5
stealthchop_threshold: 99999
interpolate: true

[tmc2209 stepper_z3]
uart_pin: PD15
run_current: 0.8
hold_current: 0.5
stealthchop_threshold: 99999
interpolate: true

# ===================================================================
# 						6. AQUECIMENTO (HEATERS)
# ===================================================================

### Mesa Aquecida (Heater Bed)
[heater_bed]
heater_pin: PB10
sensor_type: NTC 100K MGB18-104F39050L32
sensor_pin: PC3
max_power: 0.55                     # Limite de potência da mesa (55%).
control = pid
pid_kp = 28.475
pid_ki = 0.974
pid_kd = 208.225
min_temp: 0
max_temp: 120

# ===================================================================
# 						7. FANS (VENTOINHAS)
# ===================================================================

### Fan de Recirculação/Filtro (Nevermore)
[heater_fan Nevermore] 
pin: PA0
heater: heater_bed
heater_temp: 60.0                   # Liga quando a mesa aquece acima de 60°C.

### Fan Controlado por Temperatura (Eletrônica/Host)
[temperature_fan _Fan_1]
pin: PA2
max_power: 0.4
shutdown_speed: 0.0
control: watermark
max_delta: 5.0
sensor_type: temperature_host
min_temp: 0
max_temp: 100
target_temp: 65                     # Tenta manter a temperatura do Host abaixo de 65°C.

[temperature_fan _Fan_2]
pin: PA1
max_power: 0.4
shutdown_speed: 0.0
control: watermark
max_delta: 5.0
sensor_type: temperature_host
min_temp: 0
max_temp: 100
target_temp: 65

# ===================================================================
# 						8. SENSORES DE TEMPERATURA
# ===================================================================

[temperature_sensor Cabine]
sensor_type: Generic 3950
sensor_pin: PC2

[temperature_sensor Eletronica]
sensor_type: Generic 3950
sensor_pin: PC1

[temperature_sensor Btt Pi2]
sensor_type: temperature_host

[temperature_sensor MKS_Monster 8]
sensor_type: temperature_mcu

# ===================================================================
# 						9. CARTOGRAPHER E MESH
# ===================================================================

[cartographer]
mcu: cartographer
x_offset: 0
y_offset: 20
verbose: yes

[temperature_sensor cartographer]
sensor_type: temperature_mcu
sensor_mcu: cartographer
min_temp: 5
max_temp: 105

### Nivelamento Gantry (Gantry Calibration)
[quad_gantry_level]
gantry_corners:
    -58,-7
    308,318
points:
    30,20
    30,250
    260,250
    260,20
speed: 300
horizontal_move_z: 2
retries: 5
retry_tolerance: 0.009
max_adjust: 30

### Malha da Mesa (Bed Mesh)
[bed_mesh]
zero_reference_position: 150, 150
speed: 300
horizontal_move_z: 3
mesh_min: 20, 22
mesh_max: 280, 260
probe_count: 20, 20                
adaptive_margin: 10
mesh_pps: 0,0                       # Desabilita interpolação para malhas densas.

# ===================================================================
# 					10. MACROS DE IMPRESSÃO (G-CODE)
# ===================================================================

### Macro de Início de Impressão
[gcode_macro PRINT_START]
gcode:
  # This part fetches data from your slicer. Such as bed, extruder, and chamber temps and size of your printer.
  {% set target_bed = params.BED|int %}
  {% set target_extruder = params.EXTRUDER|int %}
  {% set target_chamber = params.CHAMBER|default("45")|int %}
  {% set x_wait = printer.toolhead.axis_maximum.x|float / 2 %}
  {% set y_wait = printer.toolhead.axis_maximum.y|float / 2 %}

  SET_GCODE_OFFSET Z=0                                 # Set offset to 0

  # Home the printer, set absolute positioning and update the Stealthburner LEDs.
  #STATUS_HOMING                                         # Set LEDs to homing-mode
  G28                                                   # Full home (XYZ)
  G90                                                   # Absolute position

  ##  Uncomment for bed mesh (1 of 2 for bed mesh)
  BED_MESH_CLEAR                                       # Clear old saved bed mesh (if any)

  # Check if the bed temp is higher than 90c - if so then trigger a heatsoak.
  {% if params.BED|int > 90 %}
    SET_DISPLAY_TEXT MSG="Bed: {target_bed}c"           # Display info on display
    #STATUS_HEATING                                      # Set LEDs to heating-mode
    M106 S255                                           # Turn on the PT-fan

    ##  Uncomment if you have a Nevermore.
    #SET_PIN PIN=nevermore VALUE=1                      # Turn on the nevermore

    G1 X{x_wait} Y{y_wait} Z15 F9000                    # Go to center of the bed
    M190 S{target_bed}                                  # Set the target temp for the bed
    SET_DISPLAY_TEXT MSG="Heatsoak: {target_chamber}c"  # Display info on display
    #TEMPERATURE_WAIT SENSOR="temperature_sensor chamber" MINIMUM={target_chamber}   # Waits for chamber temp

  # If the bed temp is not over 90c, then skip the heatsoak and just heat up to set temp with a 5 min soak
  {% else %}
    SET_DISPLAY_TEXT MSG="Bed: {target_bed}c"           # Display info on display
    #STATUS_HEATING                                      # Set LEDs to heating-mode
    G1 X{x_wait} Y{y_wait} Z15 F9000                    # Go to center of the bed
    M190 S{target_bed}                                  # Set the target temp for the bed
    #SET_DISPLAY_TEXT MSG="Soak for 5 min"               # Display info on display
    #G4 P300000                                          # Wait 5 min for the bedtemp to stabilize
  {% endif %}

  # Heat hotend to 150c. This helps with getting a correct Z-home.
  SET_DISPLAY_TEXT MSG="Hotend: 150c"                   # Display info on display
  M109 S146                                             # Heat hotend to 150c

  ##  Uncomment for Trident (Z_TILT_ADJUST)
  #SET_DISPLAY_TEXT MSG="Leveling"                      # Display info on display
  #STATUS_LEVELING                                      # Set LEDs to leveling-mode
  #Z_TILT_ADJUST                                        # Level the printer via Z_TILT_ADJUST
  #G28 Z                                                # Home Z again after Z_TILT_ADJUST

  ##  Uncomment for V2.4 (Quad gantry level AKA QGL)
  SET_DISPLAY_TEXT MSG="Leveling"                      # Display info on display
  #STATUS_LEVELING                                      # Set LEDs to leveling-mode
  QUAD_GANTRY_LEVEL                                    # Level the printer via QGL
  G28 Z                                                # Home Z again after QGL

  ##  Uncomment for bed mesh (2 of 2 for bed mesh)
  SET_DISPLAY_TEXT MSG="Bed mesh"                      # Display info on display
  #STATUS_MESHING                                       # Set LEDs to bed mesh-mode
  CARTOGRAPHER_TOUCH_HOME                                    # Calibrate z offset only with hot nozzle
  BED_MESH_CALIBRATE ADAPTIVE=1                                 # Start the bed mesh (add ADAPTIVE=1) for adaptive bed mesh

  

  # Heat up the hotend up to target via data from slicer
  SET_DISPLAY_TEXT MSG="Hotend: {target_extruder}c"     # Display info on display
  #STATUS_HEATING                                        # Set LEDs to heating-mode
  G1 X{x_wait} Y{y_wait} Z15 F9000                      # Go to center of the bed
  M107                                                  # Turn off partcooling fan
  M109 S{target_extruder}                               # Heat the hotend to set temp

  # Get ready to print by doing a primeline and updating the LEDs
  SET_DISPLAY_TEXT MSG="Printer goes brr"               # Display info on display
  #STATUS_PRINTING                                       # Set LEDs to printing-mode
  G0 X{x_wait - 50} Y4 F10000                           # Go to starting point
  G0 Z0.4                                               # Raise Z to 0.4
  G91                                                   # Incremental positioning 
  G1 X100 E20 F1000                                     # Primeline
  G90                                                   # Absolute position

### Macro de Fim de Impressão
[gcode_macro PRINT_END]
description: Rotina de finalização (chamada pelo Slicer)
gcode:
    M400                           ; espera o buffer esvaziar
    G92 E0                         ; zera o extrusor
    G1 E-10.0 F3600                ; retrai o filamento
    G91                            ; posicionamento relativo
    G0 Z1.00 X20.0 Y20.0 F20000    ; move o bico ligeiramente
    TURN_OFF_HEATERS
    M107                           ; desliga fan
    G1 Z5 F3000                    ; move o bico para cima
    G90                            ; posicionamento absoluto
    G0  X125 Y250 F3600            ; parqueia o bico no fundo
    BED_MESH_CLEAR                   # Limpa a malha ativa.

### Macro de Cancelamento
[gcode_macro CANCEL_PRINT]
description: Cancela a impressão em curso
rename_existing: CANCEL_PRINT_BASE
gcode:
    TURN_OFF_HEATERS
    CANCEL_PRINT_BASE

### Macro de Nivelamento Gantry Customizado
[gcode_macro QUAD_GANTRY_LEVEL]
rename_existing: BASE_QUAD_GANTRY_LEVEL
gcode:
    # Passagem 1: Nivelamento Coarse (grosso e rápido)
    BASE_QUAD_GANTRY_LEVEL HORIZONTAL_MOVE_Z=10 RETRY_TOLERANCE=1
    # Passagem 2: Nivelamento Fine (preciso)
    BASE_QUAD_GANTRY_LEVEL HORIZONTAL_MOVE_Z=2

### Macro de Limpeza de Bico
[gcode_macro CLEAN_NOZZLE]
variable_start_x: 275
variable_start_y: 311
variable_start_z: 4.5
variable_wipe_dist: -40
variable_wipe_qty: 10
variable_wipe_spd: 200
variable_raise_distance: 30

gcode:
    
    {% if "xyz" not in printer.toolhead.homed_axes %}
    G28
    {% endif %}
    G90                                            ; absoluto
    G1 X{start_x} Y{start_y} F6000
    G1 Z{start_z} F1500
    
    ## Rotina de limpeza
    {% for wipes in range(1, (wipe_qty + 1)) %}
    G1 X{start_x + wipe_dist} F{wipe_spd * 60}
    G1 X{start_x} F{wipe_spd * 60}
    {% endfor %}
    
    ## Levanta o bico
    G1 Z{raise_distance}

### Sobrescrita de Comandos M109/M190 (Melhor controle de espera de temperatura)
[gcode_macro M109]
rename_existing: M99109
gcode:
    {% set s = params.S|float %}
    M104 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
    {% if s != 0 %}
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={s} MAXIMUM={s+1}
    {% endif %}

[gcode_macro M190]
rename_existing: M99190
gcode:
    {% set s = params.S|float %}
    M140 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
    {% if s != 0 %}
        TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={s} MAXIMUM={s+1}
    {% endif %}

# ===================================================================
# 					11. EXTRAS E UTILIDADES
# ===================================================================

### Requisitos Orcaslicer (Exclusão de Objetos e Arcos)
[exclude_object]
[gcode_arcs]
resolution: 0.1

### Timeout
[idle_timeout]
timeout: 3600                       # 1 hora (3600s) de inatividade desliga heaters.

### Iluminação (Case Light)
[neopixel caselight]
pin: PA8
chain_count: 36
color_order: GRB
initial_RED: 1
initial_GREEN: 1
initial_BLUE: 1
initial_WHITE: 1

# ===================================================================
# 					12. SHAKE & TUNE (INPUT SHAPER)
# ===================================================================

[lis2dw]                            # Configuração do acelerômetro LIS2DW
cs_pin: cartographer:PA3
spi_bus: spi1

[resonance_tester]                  # Teste de ressonância (Input Shaper)
accel_chip: lis2dw
probe_points: 150, 150, 20

[shaketune]
# Parâmetros com valores padrão comentados, use-os se quiser alterar o comportamento.
# result_folder: ~/printer_data/config/ShakeTune_results
# number_of_results_to_keep: 10
# keep_raw_data: False
# show_macros_in_webui: True
# timeout: 600
# measurements_chunk_size: 2
# max_freq: 200
# dpi: 300

# ===================================================================
# 					13. AUTOTUNE TMC (PARA CALIBRAÇÃO)
# ===================================================================

[autotune_tmc stepper_x]
motor: ldo-42sth48-2804ah
voltage: 45
sgt: 1

[autotune_tmc stepper_y]
motor: ldo-42sth48-2804ah
voltage: 45
sgt: 1

[autotune_tmc stepper_z]
motor: hanpose-17hs4401

[autotune_tmc stepper_z1]
motor: hanpose-17hs4401

[autotune_tmc stepper_z2]
motor: hanpose-17hs4401

[autotune_tmc stepper_z3]
motor: hanpose-17hs4401

[autotune_tmc extruder]
motor: ldo-36sth20-1004ahg

# ===================================================================
# 				14. SAVE_CONFIG (NÃO EDITE ESTE BLOCO)
# ===================================================================
#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [cartographer touch_model default]
#*# threshold = 1156
#*# speed = 2
#*# z_offset = -0.05
#*#
#*# [cartographer scan_model default]
#*# coefficients = 1.5142849796901598,1.9995790440876502,0.8088674862632109,0.31969810364074003,0.49764087359152176,0.5871697066447323,-0.35252181349996436,-0.4955933419226402,0.33055277551796325,0.2912670808285655
#*# domain = 3.254958371089016e-07,3.350377262060901e-07
#*# z_offset = 0
#*# reference_temperature = 30.76
